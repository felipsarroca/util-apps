<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pluja d‚Äôidees i votaci√≥</title>
  <!-- Silencia nom√©s l'av√≠s del CDN de Tailwind (per mantenir l'est√®tica sense soroll a consola) -->
  <script>(function(){const w=console.warn;console.warn=function(...a){if(typeof a[0]==='string'&&a[0].includes('cdn.tailwindcss.com should not be used in production'))return;w.apply(console,a);};})();</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Poppins:wght@600;800&display=swap" rel="stylesheet" />
  <style>
    :root{ --theme-color-primary:#4f46e5; --theme-color-text:#ffffff; --theme-color-content-bg:#eef2ff; --theme-color-primary-border:#a5b4fc; --theme-color-primary-dark-text:#3730a3; }
    body{ font-family:'Inter',sans-serif; background:linear-gradient(135deg,#e9d5ff 0%,#bfdbfe 50%,#c7d2fe 100%); }
    .loader{border:4px solid #f3f3f3;border-top:4px solid var(--theme-color-primary);border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    #qrcode-container{background:#fff;border-radius:12px;padding:1rem;display:inline-flex;box-shadow:0 10px 25px -10px rgb(0 0 0 / .25)}
    .themed-bg{background-color:var(--theme-color-primary);color:var(--theme-color-text)}
    .themed-bg-hover:hover{filter:brightness(92%);transition:filter .2s,transform .15s;transform:translateY(-1px)}
    .themed-content-bg{background-color:var(--theme-color-content-bg);backdrop-filter:saturate(120%) blur(2px)}
    .idea-card{background:#fff;border-radius:.9rem;padding:.9rem 1rem;box-shadow:0 8px 20px -12px rgb(0 0 0 / .4);position:relative;transition:transform .2s,box-shadow .2s;flex-basis:100%;border:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;min-width:0;animation:fadeUp .3s ease both}
    @keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .idea-card:hover{transform:translateY(-2px);box-shadow:0 16px 30px -14px rgb(0 0 0 / .45)}
    .idea-card p{flex-grow:1;overflow-wrap:break-word;min-width:0;display:flex;align-items:center;gap:.5rem;font-size:1.05rem}
    .idea-card p::before{content:"üí°";font-size:1.1rem}
    .idea-card.has-votes{border-left:6px solid var(--theme-color-primary)}
    .vote-count{font-weight:800;font-size:1.1rem;color:var(--theme-color-primary-dark-text);margin-left:1rem}
    .vote-bar{height:8px;border-radius:4px;background-color:var(--theme-color-primary);margin-top:6px;width:0%;transition:width .35s;opacity:.9}
    #session-code{font-family:'Poppins',sans-serif;font-size:2.25rem;font-weight:800;letter-spacing:.1em;padding:.5rem 1rem;border:2px dashed var(--theme-color-primary-border);border-radius:.75rem;color:var(--theme-color-primary-dark-text);background:#fff;cursor:pointer;transition:background-color .2s,transform .15s}
    #session-code:hover{background:#f9fafb;transform:scale(1.01)}
    body.projection-mode{overflow:hidden;cursor:pointer}
    body.projection-mode #app{max-width:100%;width:100%;height:100vh;border-radius:0;padding:1rem;margin:0!important}
    body.projection-mode .hide-on-projection{display:none!important}
    body.projection-mode #results-column{height:100%}
    body.projection-mode #results-view{height:100%;display:flex;flex-direction:column}
    body.projection-mode #results-question{text-align:center;font-size:2.8rem;font-family:'Poppins',sans-serif}
    body.projection-mode #results-view .grid{grid-template-columns:1fr!important}
    body.projection-mode #results-column{grid-column:1/-1!important}
    body.projection-mode #results-view{padding:.5rem!important;border-radius:0!important}
    .voted-idea{background-color:color-mix(in srgb, var(--theme-color-primary) 15%, white);border-color:var(--theme-color-primary)}
    .voted-badge{display:inline-flex;align-items:center;justify-content:center;min-width:1.5rem;height:1.5rem;border-radius:9999px;font-size:.75rem;font-weight:700;background:var(--theme-color-primary);color:var(--theme-color-text);margin-left:.75rem;padding:0 .4rem}
    input,textarea,select,button{border-radius:.75rem!important}
    button{box-shadow:0 8px 20px -14px rgb(0 0 0 / .5)}
    #ideas-list-container{display:flex;flex-wrap:wrap;gap:1rem;align-content:flex-start;overflow-y:auto;height:100%}
  </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center justify-start min-h-screen p-4 gap-6">
  <div id="app" class="w-full max-w-6xl mx-auto transition-all duration-300 relative my-auto">

    <!-- VISTA D'INICI (PORTADA): tria r√†pida docent / codi -->
    <div id="home-view" class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="rounded-xl shadow-lg themed-content-bg p-6">
        <h2 class="text-2xl font-bold font-[Poppins] mb-2">Com a docent</h2>
        <p class="text-gray-700 mb-4">Crea una sessi√≥ nova i recull idees de l‚Äôaula.</p>
        <button onclick="switchView('presenter')" class="themed-bg themed-bg-hover font-bold py-3 px-4 rounded-lg w-full">Iniciar com a docent</button>
      </div>
      <div class="rounded-xl shadow-lg bg-white p-6">
        <h2 class="text-2xl font-bold font-[Poppins] mb-2">Tinc un codi</h2>
        <p class="text-gray-700 mb-3">Introdueix el codi per unir-te com a participant.</p>
        <div class="flex gap-2">
          <input id="code-input-home" type="text" class="flex-1 p-3 border rounded-lg uppercase" placeholder="CODI" />
          <button onclick="joinFromHome()" class="themed-bg themed-bg-hover font-bold px-4 rounded-lg">Unir-se</button>
        </div>
      </div>
    </div>

    <!-- PRESENTADOR -->
    <div id="presenter-view" class="hidden h-full">
      <div id="create-session-form" class="themed-content-bg p-6 md:p-8 rounded-xl shadow-lg">
        <h2 class="text-2xl font-bold mb-6 font-[Poppins]">Crea una nova sessi√≥</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div class="md:col-span-2">
            <label for="question" class="block text-sm font-medium text-gray-700 mb-1">T√≠tol o pregunta:</label>
            <input type="text" id="question" class="w-full p-3 border border-gray-300 rounded-md shadow-sm" placeholder="Ex: Idees per millorar el pati" />
          </div>
          <div>
            <label for="color-picker" class="block text-sm font-medium text-gray-700 mb-1">Color del tema:</label>
            <input type="color" id="color-picker" value="#4f46e5" class="w-12 h-12 p-1 border border-gray-300 rounded-md cursor-pointer" />
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label for="ideas-per-person" class="block text-sm font-medium text-gray-700 mb-1">Idees per persona:</label>
            <input type="number" id="ideas-per-person" value="1" min="1" class="w-full p-3 border border-gray-300 rounded-md shadow-sm" />
          </div>
          <div>
            <label for="votes-per-person" class="block text-sm font-medium text-gray-700 mb-1">Vots per persona:</label>
            <input type="number" id="votes-per-person" value="3" min="1" class="w-full p-3 border border-gray-300 rounded-md shadow-sm" />
          </div>
        </div>
        <div class="flex gap-3 flex-wrap">
          <button onclick="hostSession()" id="host-button" class="themed-bg themed-bg-hover font-bold py-3 px-4 rounded-lg flex items-center justify-center">
            <span>Inicia sessi√≥</span>
            <div id="host-loader" class="loader hidden ml-3"></div>
          </button>
          <button onclick="switchView('home')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-4 rounded-lg">Torna</button>
        </div>
      </div>

      <div id="results-view" class="hidden themed-content-bg p-6 md:p-8 rounded-xl shadow-lg h-full mt-6">
        <div class="flex justify-between items-start gap-4 mb-4">
          <h2 id="results-question" class="text-3xl md:text-4xl font-extrabold flex-grow text-gray-800 font-[Poppins]"></h2>
          <div class="flex gap-2 flex-shrink-0 hide-on-projection">
            <button id="start-voting-btn" onclick="startVotingPhase()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Inicia la votaci√≥</button>
            <button id="projection-btn" onclick="toggleProjectionMode()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Projecta</button>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-full">
          <div id="sharing-info-container" class="lg:col-span-1 space-y-6 hide-on-projection">
            <div class="bg-white/60 p-4 rounded-lg text-center backdrop-blur-sm">
              <h3 class="font-bold mb-2 text-gray-700">1. Escaneja el QR</h3>
              <div id="qrcode-container" class="mx-auto max-w-[200px]"></div>
            </div>
            <div class="bg-white/60 p-4 rounded-lg text-center backdrop-blur-sm">
              <h3 class="font-bold mb-2 text-gray-700">2. O comparteix l‚Äôenlla√ß</h3>
              <p id="direct-session-link" title="Copia" class="font-mono bg-gray-200 px-2 py-1 rounded text-sm my-1 break-all hover:bg-gray-300 inline-block max-w-full cursor-pointer truncate" onclick="copyText('direct-session-link')"></p>
            </div>
            <div class="bg-white/60 p-4 rounded-lg text-center backdrop-blur-sm">
              <h3 class="font-bold mb-2 text-gray-700">3. Ves a</h3>
              <p id="app-url" title="Copia" class="font-mono text-sm my-1 break-all hover:text-gray-900 inline-block max-w-full cursor-pointer hover:bg-gray-200 p-1 rounded" onclick="copyText('app-url')"></p>
              <p class="text-gray-700 text-sm my-2">i introdueix el codi:</p>
              <div class="mt-2"><span id="session-code" onclick="copyCode()"></span></div>
            </div>
          </div>
          <div id="results-column" class="lg:col-span-2 bg-white/70 rounded-lg p-4 min-h-[400px]">
            <div id="ideas-list-container"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- PARTICIPANT -->
    <div id="participant-view" class="hidden">
      <div id="join-session-form" class="bg-white p-8 rounded-xl shadow-lg">
        <h2 class="text-2xl font-bold mb-4 font-[Poppins]">Unir-se a una sessi√≥</h2>
        <label for="code-input" class="block text-sm font-medium text-gray-700 mb-1">Codi de la sessi√≥:</label>
        <div class="flex gap-2">
          <input type="text" id="code-input" class="w-full p-3 border uppercase border-gray-300 rounded-md" placeholder="CODI" />
          <button onclick="joinSession()" id="join-button" class="themed-bg themed-bg-hover font-bold px-4 rounded-lg">Unir-se</button>
        </div>
        <p class="text-center mt-6">
          <a href="#" onclick="event.preventDefault(); switchView('home')" class="text-sm text-gray-700 hover:text-indigo-600 font-medium">Torna a l‚Äôinici</a>
        </p>
      </div>

      <div id="idea-form" class="hidden bg-white p-8 rounded-xl shadow-lg mt-6">
        <h2 id="idea-form-title" class="text-2xl font-bold mb-4 font-[Poppins]"></h2>
        <p id="ideas-left" class="text-sm font-medium text-gray-500 mb-2"></p>
        <textarea id="idea-input" class="w-full p-2 border border-gray-300 rounded-md" maxlength="200" placeholder="Escriu la teva idea (m√†x. 200 car√†cters)"></textarea>
        <button id="send-idea-btn" onclick="sendIdea()" class="mt-2 themed-bg themed-bg-hover font-bold py-2 px-4 rounded-lg">Envia la idea</button>
        <p id="participant-info" class="mt-4 text-green-600"></p>
      </div>

      <div id="voting-form" class="hidden bg-white p-8 rounded-xl shadow-lg mt-6">
        <h2 id="voting-form-title" class="text-2xl font-bold mb-4 font-[Poppins]">Vota per les teves idees preferides</h2>
        <p id="votes-left" class="text-sm font-medium text-gray-500 mb-4"></p>
        <div id="ideas-to-vote-container" class="space-y-2 max-h-96 overflow-y-auto"></div>
      </div>

      <div id="completed-view" class="hidden text-center py-8">
        <h2 class="text-2xl font-bold mt-4 font-[Poppins]">Gr√†cies per participar!</h2>
        <p class="text-gray-700">Pots veure els resultats a la pantalla principal.</p>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300"></div>

  <script>
    // ======= Estat global =======
    let peer = null;               // Instance PeerJS (host o participant)
    let hostConnection = null;     // Connexi√≥ del participant -> host
    let guestConnections = [];     // Connexions entrants dels participants (host)

    let sessionData = {
      question: '',
      ideasPerPerson: 1,
      votesPerPerson: 3,
      themeColor: '#4f46e5',
      ideas: [],          // { id, text, votes }
      phase: 'submission' // 'submission' | 'voting'
    };

    let participantState = { submittedIdeas: 0, castVotes: 0, votes: {} }; // votes: { [ideaId]: 1|0 }
    let pendingVotes = {}; // { [ideaId]: 1|-1 }

    // ======= Utils =======
    function switchView(view){
      const views=['home','presenter','participant'];
      for(const v of views){ const el=document.getElementById(`${v}-view`); if(el) el.classList.add('hidden'); }
      if(view==='presenter'){ document.getElementById('presenter-view').classList.remove('hidden'); document.getElementById('app').classList.add('max-w-6xl'); }
      else if(view==='participant'){ document.getElementById('participant-view').classList.remove('hidden'); document.getElementById('app').classList.remove('max-w-6xl'); }
      else { document.getElementById('home-view').classList.remove('hidden'); document.getElementById('app').classList.remove('max-w-6xl'); }
    }
    function applyTheme(color){
      const r=document.documentElement; r.style.setProperty('--theme-color-primary',color);
      const R=parseInt(color.slice(1,3),16),G=parseInt(color.slice(3,5),16),B=parseInt(color.slice(5,7),16);
      const yiq=((R*299)+(G*587)+(B*114))/1000; const t=(yiq>=128)?'#000000':'#ffffff';
      r.style.setProperty('--theme-color-text',t);
      r.style.setProperty('--theme-color-content-bg',color+'1A');
      r.style.setProperty('--theme-color-primary-border',color+'80');
      r.style.setProperty('--theme-color-primary-dark-text', `color-mix(in srgb, ${color} 70%, black)`);
    }
    function showToast(text){ const t=document.getElementById('toast'); t.innerText=text; t.style.opacity=1; setTimeout(()=>t.style.opacity=0,1800); }
    function copyText(id){ const el=document.getElementById(id); if(!el) return; navigator.clipboard.writeText(el.innerText).then(()=>showToast('Copiat!')); }
    function copyCode(){ copyText('session-code'); }

    // ======= HOST =======
    function hostSession(){
      sessionData.question = document.getElementById('question').value.trim();
      if(!sessionData.question){ alert('Introdueix un t√≠tol o pregunta.'); return; }
      sessionData.ideasPerPerson = parseInt(document.getElementById('ideas-per-person').value,10);
      sessionData.votesPerPerson = parseInt(document.getElementById('votes-per-person').value,10);
      sessionData.themeColor = document.getElementById('color-picker').value;
      applyTheme(sessionData.themeColor);

      const sessionId = Math.random().toString(36).substring(2,8).toUpperCase();
      peer = new Peer(sessionId);

      peer.on('open', id => {
        document.getElementById('create-session-form').classList.add('hidden');
        document.getElementById('results-view').classList.remove('hidden');
        const base = window.location.href.split('?')[0];
        const sessionUrl = `${base}?session=${id}`;
        document.getElementById('session-code').innerText = id;
        document.getElementById('direct-session-link').innerText = sessionUrl;
        document.getElementById('app-url').innerText = base.replace(/^https?:\/\//,'');
        document.getElementById('results-question').innerText = sessionData.question;
        document.getElementById('home-view').classList.add('hidden');
        new QRCode(document.getElementById('qrcode-container'),{ text: sessionUrl, width:160, height:160 });
        updateIdeasListView();
      });

      peer.on('connection', conn => {
        guestConnections.push(conn);
        conn.on('open', () => conn.send({ type:'session-data', payload: sessionData }));
        conn.on('data', data => handleGuestData(conn, data));
        conn.on('close', () => { guestConnections = guestConnections.filter(c => c.peer !== conn.peer); });
      });

      peer.on('error', err => { console.error('PeerJS error:', err); alert('No s\'ha pogut iniciar la sessi√≥. Revisa la consola.'); });
    }

    function handleGuestData(conn, data){
      if(data.type==='new-idea'){
        const newIdea = { id:'idea-'+Date.now()+Math.random(), text:data.payload, votes:0 };
        sessionData.ideas.push(newIdea);
      } else if(data.type==='vote'){
        const { ideaId, delta } = data.payload;
        const idea = sessionData.ideas.find(i=>i.id===ideaId);
        if(idea){ idea.votes += delta; conn.send({ type:'vote-confirm', payload:{ ideaId, delta } }); }
      }
      broadcastUpdate();
    }

    function updateIdeasListView(){
      const container = document.getElementById('ideas-list-container');
      container.innerHTML='';
      const sorted = [...sessionData.ideas].sort((a,b)=>b.votes-a.votes);
      sorted.forEach(idea=>{
        const card = document.createElement('div');
        card.className = 'idea-card'+(idea.votes!==0?' has-votes':'');
        const controls = document.createElement('div');
        controls.className = 'flex items-center';
        if(sessionData.phase==='voting'){
          const vc=document.createElement('div'); vc.className='vote-count'; vc.innerText=idea.votes; controls.appendChild(vc);
        }
        if(sessionData.phase==='submission'){
          const del=document.createElement('button'); del.className='text-gray-500 hover:text-red-600'; del.innerText='üóëÔ∏è'; del.title='Elimina'; del.onclick=(e)=>{e.stopPropagation(); deleteIdea(idea.id);}; controls.appendChild(del);
        }
        card.innerHTML = `<p>${idea.text}</p>`; card.appendChild(controls); container.appendChild(card);
      });
      requestAnimationFrame(()=>{
        const cards=container.querySelectorAll('.idea-card');
        const counts=Array.from(cards).map(c=>parseInt(c.querySelector('.vote-count')?.textContent||'0'));
        const max=Math.max(1,...counts);
        cards.forEach(c=>{ let bar=c.querySelector('.vote-bar'); if(!bar){ bar=document.createElement('div'); bar.className='vote-bar'; c.appendChild(bar);} const n=parseInt(c.querySelector('.vote-count')?.textContent||'0'); bar.style.width=(n/max)*100+'%'; bar.style.display=(sessionData.phase==='voting')?'block':'none'; });
      });
    }

    function deleteIdea(id){ const ix=sessionData.ideas.findIndex(i=>i.id===id); if(ix>-1){ sessionData.ideas.splice(ix,1); broadcastUpdate(); } }
    function startVotingPhase(){ sessionData.phase='voting'; document.getElementById('start-voting-btn').style.display='none'; broadcastUpdate(); }
    function broadcastUpdate(){ updateIdeasListView(); guestConnections.forEach(c=>c.send({ type:'session-data', payload:sessionData })); }

    // ======= Participant =======
    function saveVotesToStorage(){ const id=hostConnection?hostConnection.peer:null; if(!id) return; localStorage.setItem(`votes_${id}`, JSON.stringify(participantState)); }
    function loadVotesFromStorage(id){ if(!id) return; const d=localStorage.getItem(`votes_${id}`); if(d){ try{ const s=JSON.parse(d); if(s && typeof s.votes==='object'){ participantState=s; } }catch(e){ participantState={ submittedIdeas:0, castVotes:0, votes:{} }; } } }
    function recomputeCastVotes(){ participantState.castVotes=Object.values(participantState.votes).reduce((a,v)=>a+(v?1:0),0); }
    function findIdeaButton(id){ return document.querySelector(`#ideas-to-vote-container button[data-id="${id}"]`); }
    function setButtonPending(btn,p){ if(!btn) return; if(p){ btn.classList.add('opacity-60','pointer-events-none'); const b=btn.querySelector('.voted-badge'); if(b) b.style.display='none'; } else { btn.classList.remove('opacity-60','pointer-events-none'); } }
    function setButtonConfirmed(btn,v){ if(!btn) return; if(v){ btn.classList.add('voted-idea'); const b=btn.querySelector('.voted-badge'); if(b){ b.textContent=1; b.style.display='inline-flex'; } } else { btn.classList.remove('voted-idea'); const b=btn.querySelector('.voted-badge'); if(b) b.style.display='none'; } }

    function joinFromHome(){ const c=document.getElementById('code-input-home').value.trim().toUpperCase(); if(!c) return; document.getElementById('code-input').value=c; switchView('participant'); joinSession(); }
    function joinSession(){ const hostId=document.getElementById('code-input').value.trim().toUpperCase(); if(!hostId) return; loadVotesFromStorage(hostId); peer=new Peer(); peer.on('open',()=>{ hostConnection=peer.connect(hostId,{reliable:true}); hostConnection.on('data', data=>{ if(data.type==='session-data'){ sessionData=data.payload; applyTheme(sessionData.themeColor); updateParticipantView(); } else if(data.type==='vote-confirm'){ const {ideaId,delta}=data.payload; delete pendingVotes[ideaId]; participantState.votes[ideaId]=(delta===1?1:0); recomputeCastVotes(); saveVotesToStorage(); const btn=findIdeaButton(ideaId); setButtonPending(btn,false); setButtonConfirmed(btn, participantState.votes[ideaId]===1); const left=sessionData.votesPerPerson-participantState.castVotes; const el=document.getElementById('votes-left'); if(el) el.innerText=`Pots votar ${left} idees`; if(participantState.castVotes>=sessionData.votesPerPerson && sessionData.ideas.some(i=>participantState.votes[i.id])){ document.getElementById('completed-view').classList.remove('hidden'); document.getElementById('voting-form').classList.add('hidden'); } } }); }); }

    function updateParticipantView(){
      document.getElementById('join-session-form').classList.add('hidden');
      document.getElementById('idea-form').classList.add('hidden');
      document.getElementById('voting-form').classList.add('hidden');
      document.getElementById('completed-view').classList.add('hidden');

      if(sessionData.phase==='submission'){
        document.getElementById('idea-form').classList.remove('hidden');
        document.getElementById('idea-form-title').innerText=sessionData.question;
        const left=sessionData.ideasPerPerson-participantState.submittedIdeas;
        if(participantState.submittedIdeas < sessionData.ideasPerPerson){
          document.getElementById('ideas-left').innerText=`Et queden ${left} idees`;
          document.getElementById('idea-input').style.display='block';
          document.getElementById('send-idea-btn').style.display='inline-flex';
          document.getElementById('participant-info').innerText='';
        } else {
          document.getElementById('ideas-left').innerText='';
          document.getElementById('idea-input').style.display='none';
          document.getElementById('send-idea-btn').style.display='none';
          document.getElementById('participant-info').innerText='Has enviat totes les teves idees. Espera que el/la docent inici√Ø la votaci√≥‚Ä¶';
        }
      } else if(sessionData.phase==='voting'){
        if(participantState.castVotes>=sessionData.votesPerPerson && sessionData.ideas.some(i=>participantState.votes[i.id])){ document.getElementById('completed-view').classList.remove('hidden'); return; }
        document.getElementById('voting-form').classList.remove('hidden');
        document.getElementById('voting-form-title').innerText=sessionData.question;
        const left=sessionData.votesPerPerson-participantState.castVotes; document.getElementById('votes-left').innerText=`Pots votar ${left} idees`;
        const container=document.getElementById('ideas-to-vote-container'); container.innerHTML='';
        sessionData.ideas.forEach(idea=>{ const btn=document.createElement('button'); btn.className='w-full p-3 border rounded-lg hover:bg-gray-100 flex items-center justify-between text-left'; btn.dataset.id=idea.id; btn.innerHTML=`<span class="truncate mr-3">${idea.text}</span><span class="voted-badge" style="display:none"></span>`; const confirmed=participantState.votes[idea.id]||0; if(confirmed>0){ setButtonConfirmed(btn,true); } if(pendingVotes[idea.id]){ setButtonPending(btn,true); } btn.onclick=()=>castVote(idea.id, btn); container.appendChild(btn); });
      }
    }

    function sendIdea(){ const txt=document.getElementById('idea-input').value.trim(); if(!txt) return; hostConnection.send({type:'new-idea', payload: txt}); participantState.submittedIdeas++; saveVotesToStorage(); document.getElementById('idea-input').value=''; document.getElementById('participant-info').innerText='Idea enviada!'; setTimeout(updateParticipantView, 600); }

    function castVote(ideaId, btn){ const already=(participantState.votes[ideaId]||0)===1; const pending=pendingVotes[ideaId]||0; if(pending!==0) return; const delta= already? -1 : 1; if(delta===1 && participantState.castVotes>=sessionData.votesPerPerson) return; pendingVotes[ideaId]=delta; setButtonPending(btn,true); hostConnection.send({ type:'vote', payload:{ ideaId, delta } }); }

    // ======= Projecci√≥ =======
    function handleExitProjection(e){ if(e.key==='Escape' || (e.type==='click' && e.target.tagName!=='BUTTON' && !e.target.closest('button'))){ if(document.body.classList.contains('projection-mode')) toggleProjectionMode(); } }
    function toggleProjectionMode(){ const entering=!document.body.classList.contains('projection-mode'); document.body.classList.toggle('projection-mode'); if(entering){ window.addEventListener('keydown', handleExitProjection); document.getElementById('app').addEventListener('click', handleExitProjection);} else { window.removeEventListener('keydown', handleExitProjection); document.getElementById('app').removeEventListener('click', handleExitProjection); } }

    // ======= Inici =======
    window.onload = () => {
      const p = new URLSearchParams(window.location.search); const sid=p.get('session');
      if(sid){ document.getElementById('code-input').value=sid; switchView('participant'); joinSession(); }
      else { switchView('home'); }
      applyTheme(sessionData.themeColor);
      document.getElementById('color-picker')?.addEventListener('input',e=>applyTheme(e.target.value));
    };
  </script>
</body>
</html>
